// scripts/generate-comparisons.mjs

import fs from "fs";
import path from "path";
import OpenAI from "openai";
import { comparisonPairs } from "../data/comparisonPairs.js";

const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// Helper: turn an id into a nice label
function labelFromId(id) {
  if (!id) return "Section";
  const map = {
    "what-it-is": "What it is",
    "how-it-works": "How it works",
    "when-to-use-which": "When to use which",
  };
  if (map[id]) return map[id];

  // Generic: "some-id" -> "Some Id"
  return id
    .replace(/[-_]+/g, " ")
    .replace(/\b\w/g, (c) => c.toUpperCase());
}

// Normalize sections to always have id + label + a + b
function normalizeSections(rawSections) {
  if (!Array.isArray(rawSections)) return [];

  return rawSections.map((sec, idx) => {
    const id =
      sec.id ||
      (idx === 0
        ? "what-it-is"
        : idx === 1
        ? "how-it-works"
        : idx === 2
        ? "when-to-use-which"
        : `section-${idx + 1}`);

    const label = sec.label || labelFromId(id);

    return {
      id,
      label,
      a: sec.a ?? "",
      b: sec.b ?? "",
    };
  });
}

async function generateComparison(pair) {
  const { topicA, topicB } = pair;

  console.log(`\n=== Generating: ${topicA} vs ${topicB} ===`);

  const prompt = `
You are an expert AI educator for busy product managers.
Write a clear, concise comparison between these two concepts:

- Concept A: ${topicA}
- Concept B: ${topicB}

Focus on LLMs / practical product use.

Return ONLY valid JSON with this exact shape:

{
  "title": "string, e.g. 'BERT vs GPT'",
  "sections": [
    {
      "id": "what-it-is",
      "label": "What it is",
      "a": "2-4 sentences describing Concept A",
      "b": "2-4 sentences describing Concept B"
    },
    {
      "id": "how-it-works",
      "label": "How it works",
      "a": "2-4 sentences describing how Concept A works",
      "b": "2-4 sentences describing how Concept B works"
    },
    {
      "id": "when-to-use-which",
      "label": "When to use which",
      "a": "When Concept A is the right mental model or tool",
      "b": "When Concept B is the right mental model or tool"
    }
  ],
  "relation": "3–6 sentences explaining how the two concepts relate, whether they are complementary or alternatives, and how they interact in real LLM systems."
}
`;

  const response = await client.chat.completions.create({
    model: "gpt-4.1-mini",
    temperature: 0.4,
    messages: [
      {
        role: "system",
        content: "You explain AI concepts crisply for senior PMs.",
      },
      { role: "user", content: prompt },
    ],
  });

  const raw = response.choices[0]?.message?.content ?? "";
  const jsonText = raw.slice(raw.indexOf("{"), raw.lastIndexOf("}") + 1);

  let parsed;
  try {
    parsed = JSON.parse(jsonText);
  } catch (err) {
    console.error("Failed to parse JSON for pair:", pair);
    console.error("Raw model output:\n", raw);
    throw err;
  }

  const sections = normalizeSections(parsed.sections);

  return {
    topicA,
    topicB,
    title: parsed.title,
    sections,
    relation: parsed.relation ?? "",
  };
}

async function main() {
  const records = [];

  for (const pair of comparisonPairs) {
    try {
      const rec = await generateComparison(pair);
      records.push(rec);
    } catch (err) {
      console.error("❌ Error generating comparison for pair:", pair);
      console.error(err);
    }
  }

  const outPath = path.join(process.cwd(), "data", "comparisons.ts");

  const fileContents = `// AUTO-GENERATED by scripts/generate-comparisons.mjs
// Do not edit by hand; change data/comparisonPairs.js and re-run the script.

export type ComparisonSection = {
  id: string;
  label: string;
  a: string;
  b: string;
};

export type ComparisonRecord = {
  topicA: string;
  topicB: string;
  title: string;
  sections: ComparisonSection[];
  relation: string;
};

export const comparisons: ComparisonRecord[] = ${JSON.stringify(
    records,
    null,
    2
  )};
`;

  fs.writeFileSync(outPath, fileContents, "utf8");
  console.log(`\n✅ Wrote ${records.length} comparisons to ${outPath}`);
}

main().catch((err) => {
  console.error("Fatal error in generate-comparisons.mjs");
  console.error(err);
  process.exit(1);
});
